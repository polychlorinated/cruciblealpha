<!DOCTYPE html>
<html>
<head>
    <title>AOJA Scanner</title>
    <style>
        body { font-family: system-ui; max-width: 700px; margin: 40px auto; padding: 20px; background: #f5f7fa; }
        #downloads-bar { position: fixed; top: 0; left: 0; right: 0; background: #2c3e50; color: white; padding: 10px 20px; display: none; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #downloads-bar h3 { margin: 0 0 10px 0; font-size: 14px; }
        .download-item { display: inline-block; margin-right: 15px; background: #3498db; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .download-item:hover { background: #2980b9; }
        .intro { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 50px; }
        .question { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; display: none; }
        .question.active { display: block; }
        .scale { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; }
        .scale button { padding: 12px 20px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 4px; }
        .scale button:hover { background: #e0e0e0; }
        textarea { width: 100%; margin-top: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #result, #personal-result { margin-top: 30px; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #result { background: #fff; }
        #personal-result { background: #e8f5e9; border-left: 4px solid #4CAF50; }
        h1 { color: #333; margin-bottom: 10px; }
        h2 { margin-top: 30px; color: #444; }
        h3 { margin-top: 20px; color: #555; }
        .progress { margin-bottom: 20px; font-weight: bold; color: #666; }
    </style>
</head>
<body>
    <div id="downloads-bar">
        <h3>ðŸ“¥ Available Reports</h3>
        <div id="download-items"></div>
    </div>

    <div class="intro" id="intro">
        <h1>AOJA Job Safety Scanner</h1>
        <p><strong>Step 1:</strong> Complete 5-question trauma assessment</p>
        <p><strong>Step 2:</strong> Get personal AOJA score</p>
        <p><strong>Step 3:</strong> Scan any job description against YOUR pattern</p>
        <p style="font-size: 0.9em; color: #666;">For comprehensive internal assessment (resume + full history), see Layer 2: Guided Mapping ($2,500)</p>
        <button onclick="startAssessment()">Start Assessment</button>
    </div>

    <div id="assessment-container" style="display: none;">
        <div class="progress" id="progress">Question 1 of 5</div>
        <div id="question-container"></div>
    </div>
    
    <div id="job-container" style="display: none;">
        <h2>Job Description</h2>
        <textarea id="job" rows="6" placeholder="Paste the job description here..."></textarea>
        <button onclick="submitScan()">Get Job AOJA Score</button>
    </div>
    
    <div id="result"></div>
    <div id="personal-result"></div>

    <script>
        const traumaQuestions = [
            {key: "safety_baseline", text: "I have never felt fundamentally safe at work."},
            {key: "adhd_wiring", text: "Execution tasks (repetitive, post-launch) deplete me within 3 months."},
            {key: "capability", text: "I discount my capabilities unless externally validated."},
            {key: "co_regulation", text: "I need co-regulation (trusted colleague) to feel stable."},
            {key: "financial", text: "Financial stress is actively crushing me."}
        ];
        
        let currentQuestion = 0;
        let traumaData = {};
        let availableReports = [];
        
        function showDownloadsBar() {
            const bar = document.getElementById('downloads-bar');
            const items = document.getElementById('download-items');
            
            if (availableReports.length > 0) {
                bar.style.display = 'block';
                items.innerHTML = availableReports.map(r => 
                    `<div class="download-item" onclick="${r.action}">${r.label}</div>`
                ).join('');
            }
        }
        
        function startAssessment() {
            document.getElementById('intro').style.display = 'none';
            document.getElementById('assessment-container').style.display = 'block';
            init();
        }
        
        function init() {
            const container = document.getElementById('question-container');
            traumaQuestions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'question' + (i === 0 ? ' active' : '');
                div.innerHTML = `
                    <p><strong>Question ${i+1}/5:</strong> ${q.text}</p>
                    <p style="font-size: 0.85em; color: #666; margin: 8px 0;">Rate from 1 (strongly agree) to 10 (strongly disagree)</p>
                    <div class="scale">
                        ${[1,2,3,4,5,6,7,8,9,10].map(n => 
                            `<button onclick="selectAnswer('${q.key}', ${n})">${n}</button>`
                        ).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
            updateProgress();
        }
        
        function updateProgress() {
            document.getElementById('progress').textContent = `Question ${currentQuestion + 1} of 5`;
        }
        
        function selectAnswer(key, value) {
            traumaData[key] = value;
            document.querySelectorAll('.question')[currentQuestion].classList.remove('active');
            currentQuestion++;
            updateProgress();
            
            if (currentQuestion < traumaQuestions.length) {
                document.querySelectorAll('.question')[currentQuestion].classList.add('active');
            } else {
                document.getElementById('assessment-container').style.display = 'none';
                document.getElementById('progress').style.display = 'none';
                document.getElementById('job-container').style.display = 'block';
                
                if (!availableReports.find(r => r.label.includes('Personal'))) {
                    availableReports.push({
                        label: "ðŸ“Š Personal AOJA Report (complete survey)",
                        action: "downloadPersonalReport()"
                    });
                    showDownloadsBar();
                }
            }
        }
        
        async function submitScan() {
            const jobText = document.getElementById('job').value;
            if (!jobText.trim()) return alert('Please paste a job description');
            
            document.getElementById('result').innerHTML = '<p>Scanning job against your trauma pattern...</p>';
            
            try {
                const response = await fetch('/api/scan-job', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        job_description: jobText,
                        trauma: traumaData
                    })
                });
                
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const result = await response.json();
                document.getElementById('result').innerHTML = `
                    <h3>Job AOJA Score: ${result.score}/100</h3>
                    <p><strong>Risk Level:</strong> ${result.risk_level.toUpperCase()}</p>
                    <p><strong>Summary:</strong> ${result.summary}</p>
                    ${result.red_flags.length ? '<h4>Red Flags:</h4><ul>' + result.red_flags.map(f => `<li>${f}</li>`).join('') + '</ul>' : '<p style="color: green;">No immediate red flags for YOUR pattern.</p>'}
                `;
                
                if (!availableReports.find(r => r.label.includes('Job'))) {
                    availableReports.push({
                        label: "ðŸ“„ Latest Job AOJA Report",
                        action: "downloadLatestJobReport()"
                    });
                    showDownloadsBar();
                }
            } catch (err) {
                document.getElementById('result').innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
            }
        }
        
        async function downloadPersonalReport() {
            if (Object.keys(traumaData).length < 5) {
                return alert('Please complete all 5 questions first.');
            }
            
            try {
                const response = await fetch('/api/personal-report', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ trauma: traumaData })
                });
                
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const result = await response.json();
                
                // Enhanced JSON with explanations
                const enrichedResult = {
                    ...result,
                    explanation: {
                        "Safety Baseline": "Lower scores indicate higher need for workplace safety accommodations",
                        "ADHD Wiring": "Lower scores indicate execution tasks will deplete you rapidly",
                        "Capability": "Lower scores indicate imposter syndrome is active",
                        "Co-regulation": "Lower scores indicate you need relational support structures",
                        "Financial": "Lower scores indicate financial stress is actively harmful"
                    },
                    next_steps: [
                        "Review jobs that scored 75+ on AOJA scan",
                        "Negotiate async-first schedule in interviews",
                        "Build co-regulation partnership before accepting offer"
                    ],
                    generated_at: new Date().toISOString(),
                    version: "AOJA v1.0"
                };
                
                const blob = new Blob([JSON.stringify(enrichedResult, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `personal-aoja-report-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                document.getElementById('personal-result').innerHTML = `
                    <h3>âœ… Personal Report Downloaded</h3>
                    <p><strong>Your Score:</strong> ${result.personal_score}/100</p>
                    <p><strong>Archetype:</strong> ${result.archetype}</p>
                    <p>Check your downloads folder for detailed JSON with explanations and next steps.</p>
                `;
            } catch (err) {
                alert('Download failed: ' + err.message);
            }
        }
        
        function downloadLatestJobReport() {
            const jobResult = document.getElementById('result').innerHTML;
            if (!jobResult.includes('Job AOJA Score')) {
                return alert('No job report available yet. Scan a job first.');
            }
            
            const score = document.querySelector('#result h3')?.textContent || 'N/A';
            const risk = document.querySelector('#result p strong')?.textContent || 'N/A';
            const summary = Array.from(document.querySelectorAll('#result p')).map(p => p.textContent).join('\n');
            
            const report = {
                timestamp: new Date().toISOString(),
                job_description: document.getElementById('job').value,
                your_trauma_pattern: traumaData,
                result: { score, risk, summary },
                methodology: "AOJA scoring weighted by your trauma responses",
                version: "AOJA v1.0"
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `job-aoja-report-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

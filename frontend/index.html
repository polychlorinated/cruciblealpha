<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOJA Scanner</title>
    <style>
        /* Your existing CSS from previous response */
        :root {
            --safe-green: #10b981;
            --caution-yellow: #f59e0b;
            --critical-red: #ef4444;
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 32px;
            position: relative;
        }
        .credit-bar {
            position: absolute;
            top: -20px;
            left: 0;
            right: 0;
            background: #3730a3;
            color: white;
            padding: 12px 24px;
            border-radius: 12px 12px 0 0;
            display: none;
            justify-content: space-between;
            align-items: center;
        }
        .credit-bar.active { display: flex; }
        .credits { font-weight: 600; }
        .account-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .rating-scale {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }
        .rating-btn {
            padding: 14px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .rating-btn.selected {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }
        .nav-buttons {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
    </style>
</head>
<body>
    <!-- CLERK AUTH WIDGET -->
    <div id="clerk-auth" style="position: fixed; top: 20px; right: 20px;"></div>

    <div class="container">
        <div class="credit-bar" id="creditBar">
            <div class="credits">Credits: <span id="creditCount">0</span></div>
            <button class="account-btn" onclick="purchaseCredits()">Add Credits</button>
        </div>

        <div id="page-welcome" class="page active">
            <h1>AOJA Job Scanner</h1>
            <p>Trauma-informed job matching for ADHD & CPTSD professionals.</p>
            <button class="btn btn-primary" onclick="startAssessment()">Start Free Scan</button>
            <div id="user-info" style="margin-top: 20px;"></div>
        </div>

        <!-- Survey pages (add your 5 questions here) -->
        <div id="page-survey" class="page">
            <h2 id="questionTitle">Question 1 of 5</h2>
            <div id="questionText" class="question-text"></div>
            <div class="rating-scale" id="ratingScale"></div>
            <div class="nav-buttons">
                <button class="btn" onclick="prevQuestion()">Back</button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>Next</button>
            </div>
        </div>

        <!-- Job input page -->
        <div id="page-job" class="page">
            <h2>Paste Job Description</h2>
            <textarea id="jobDescription" rows="8" style="width: 100%; padding: 12px;"></textarea>
            <div class="nav-buttons">
                <button class="btn" onclick="resetApp()">Start Over</button>
                <button class="btn btn-primary" onclick="scanJob()">Scan Job (1 Credit)</button>
            </div>
        </div>

        <!-- Results page -->
        <div id="page-results" class="page">
            <h1>AOJA Score: <span id="overallScore"></span></h1>
            <div id="dimensionalScores"></div>
            <div class="nav-buttons">
                <button class="btn" onclick="resetApp()">Scan Another</button>
                <button class="btn btn-primary" onclick="downloadReport()">Download Report</button>
            </div>
        </div>
    </div>

    <!-- CLERK CDN -->
    <script type="module">
        import Clerk from 'https://cdn.jsdelivr.net/npm/@clerk/clerk-js@4/dist/clerk.browser.js';
        
        const clerkPubKey = 'pk_test_YYYYYYYYYYYYYYYYYYYYYYYY'; // YOUR FRONTEND KEY
        
        window.Clerk = new Clerk(clerkPubKey);
        await window.Clerk.load({
            frontendApi: 'adequate-lioness-36.clerk.accounts.dev'
        });

        // Render auth button
        const authDiv = document.getElementById('clerk-auth');
        if (window.Clerk.user) {
            authDiv.innerHTML = `<button onclick="window.Clerk.signOut()">Sign Out</button>`;
            document.getElementById('creditBar').classList.add('active');
            fetchCredits(window.Clerk.user.id);
        } else {
            window.Clerk.mountSignIn(authDiv);
        }

        // Listen for auth changes
        window.Clerk.addListener(({ user }) => {
            if (user) {
                localStorage.setItem('clerk_user_id', user.id);
                document.getElementById('creditBar').classList.add('active');
                fetchCredits(user.id);
            } else {
                localStorage.removeItem('clerk_user_id');
                document.getElementById('creditBar').classList.remove('active');
            }
        });
    </script>

    <script>
        // ===== YOUR APPLICATION STATE =====
        const appState = {
            currentQuestion: 0,
            traumaData: {},
            userId: localStorage.getItem('clerk_user_id'),
            credits: 0
        };

        const questions = [
            { key: 'safety_baseline', text: "I have never felt fundamentally safe at work." },
            { key: 'adhd_wiring', text: "Execution tasks (repetitive, post-launch) deplete me within 3 months." },
            { key: 'capability', text: "I discount my capabilities unless externally validated." },
            { key: 'co_regulation', text: "I need co-regulation (trusted colleague) to feel stable." },
            { key: 'financial', text: "Financial stress is actively crushing me." }
        ];

        // ===== CREDIT MANAGEMENT =====
        async function fetchCredits(userId) {
            try {
                const response = await fetch('/api/user/credits', {
                    headers: { 'Authorization': `Bearer ${userId}` }
                });
                const data = await response.json();
                appState.credits = data.credits;
                document.getElementById('creditCount').textContent = data.credits;
            } catch (e) {
                console.error('Failed to fetch credits:', e);
            }
        }

        async function purchaseCredits() {
            if (!appState.userId) {
                alert('Please sign in first');
                return;
            }
            
            try {
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${appState.userId}`
                    },
                    body: JSON.stringify({ creditAmount: 1, price: 500 })
                });
                
                const { sessionId } = await response.json();
                
                // Redirect to Stripe Checkout
                const stripe = await loadStripe('pk_test_your_stripe_key');
                await stripe.redirectToCheckout({ sessionId });
            } catch (e) {
                alert('Payment error: ' + e.message);
            }
        }

        // ===== SURVEY LOGIC =====
        function startAssessment() {
            document.getElementById('page-welcome').classList.remove('active');
            document.getElementById('page-survey').classList.add('active');
            showQuestion(0);
        }

        function showQuestion(index) {
            appState.currentQuestion = index;
            document.getElementById('questionTitle').textContent = `Question ${index + 1} of 5`;
            document.getElementById('questionText').textContent = questions[index].text;
            
            const scale = document.getElementById('ratingScale');
            scale.innerHTML = '';
            
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'rating-btn';
                btn.textContent = i;
                btn.onclick = () => selectAnswer(questions[index].key, i);
                scale.appendChild(btn);
            }
            
            const unableBtn = document.createElement('button');
            unableBtn.className = 'rating-btn';
            unableBtn.textContent = 'Unable to Assess';
            unableBtn.onclick = () => selectAnswer(questions[index].key, null);
            scale.appendChild(unableBtn);
        }

        function selectAnswer(key, value) {
            appState.traumaData[key] = value;
            document.getElementById('nextBtn').disabled = false;
            
            // Auto-save if user is signed in
            if (appState.userId) {
                fetch('/api/save-trauma-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${appState.userId}`
                    },
                    body: JSON.stringify({ trauma: appState.traumaData })
                });
            }
        }

        function nextQuestion() {
            if (appState.currentQuestion < questions.length - 1) {
                showQuestion(appState.currentQuestion + 1);
                document.getElementById('nextBtn').disabled = true;
            } else {
                document.getElementById('page-survey').classList.remove('active');
                document.getElementById('page-job').classList.add('active');
            }
        }

        // ===== JOB SCANNING =====
        async function scanJob() {
            const jobText = document.getElementById('jobDescription').value;
            if (!jobText) {
                alert('Please paste a job description');
                return;
            }
            
            // Check credits
            if (appState.userId && appState.credits <= 0) {
                if (!confirm('No credits. Create free account for 5 free credits?')) {
                    return;
                }
                // Clerk sign-up will trigger automatically
                return;
            }
            
            document.getElementById('page-job').classList.remove('active');
            document.getElementById('page-results').classList.add('active');
            
            try {
                const response = await fetch('/api/scan-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': appState.userId ? `Bearer ${appState.userId}` : undefined
                    },
                    body: JSON.stringify({
                        job_description: jobText,
                        trauma: appState.traumaData,
                        consume_credit: !!appState.userId
                    })
                });
                
                const result = await response.json();
                displayResults(result);
            } catch (e) {
                alert('Scan failed: ' + e.message);
            }
        }

        function displayResults(result) {
            document.getElementById('overallScore').textContent = result.overall_score.toFixed(1);
            
            const dimsContainer = document.getElementById('dimensionalScores');
            dimsContainer.innerHTML = result.dimensional_match.map(dim => `
                <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <strong>${dim.dimension}</strong>
                        <span>${dim.match_percentage}%</span>
                    </div>
                    <div style="width: 100%; background: #e5e7eb; height: 8px; border-radius: 4px;">
                        <div style="width: ${dim.match_percentage}%; background: ${dim.critical ? '#ef4444' : dim.match_percentage < 75 ? '#f59e0b' : '#10b981'}; height: 8px; border-radius: 4px;"></div>
                    </div>
                    <div style="font-size: 14px; color: #6b7280; margin-top: 4px;">${dim.risk_level}</div>
                </div>
            `).join('');
        }

        function resetApp() {
            location.reload();
        }

        // ===== STRIPE LOAD HELPER =====
        async function loadStripe(key) {
            const script = document.createElement('script');
            script.src = 'https://js.stripe.com/v3/';
            script.async = true;
            document.head.appendChild(script);
            await new Promise(resolve => script.onload = resolve);
            return window.Stripe(key);
        }
    </script>
</body>
</html>
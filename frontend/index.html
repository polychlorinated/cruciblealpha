<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AOJA - Trauma-Informed Job Scanner</title>

  <!-- Injected by FastAPI from .env - DO NOT MODIFY THIS LINE -->
  <script>
    window.STRIPE_PUBLISHABLE_KEY = 'INJECT_ME';
  </script>

  <!-- Backend injects Clerk key here -->
  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key=""
    src="https://adequate-lioness-36.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
    type="text/javascript">
  </script>

  <style>
    :root { --border-color:#e5e7eb; --primary-color:#3b82f6; --success-color:#10b981; --danger-color:#ef4444; }
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; margin:0; padding:80px 12px 24px; background:#f9fafb; color:#111827; }
    header { position:fixed; top:0; left:0; right:0; background:white; border-bottom:1px solid var(--border-color); padding:12px 24px; z-index:1000; display:flex; justify-content:space-between; align-items:center; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .logo { font-size:20px; font-weight:700; color:var(--primary-color); }
    .header-controls { display:flex; align-items:center; gap:12px; }
    .credit-display { font-size:14px; font-weight:600; color:var(--primary-color); }
    .credit-display.warning { color:var(--danger-color); }
    .container { max-width:900px; margin:0 auto; padding:0 12px; }
    .page { display:none; } .page.active { display:block; }

    .progress-bar { width:100%; height:8px; background:var(--border-color); border-radius:4px; margin-bottom:32px; overflow:hidden; }
    .progress-fill { height:100%; background:var(--primary-color); transition:width 0.3s ease; }

    .options { display:grid; grid-template-columns:1fr; gap:12px; margin-top:16px; }
    .option { padding:16px; border:2px solid var(--border-color); border-radius:8px; cursor:pointer; transition:all 0.2s; }
    .option:hover { border-color:var(--primary-color); background:#f9fafb; }
    .option.selected { border-color:var(--primary-color); background:#eff6ff; color:var(--primary-color); font-weight:600; }

    .btn { padding:12px 24px; border:none; border-radius:6px; font-size:16px; font-weight:600; cursor:pointer; transition:all 0.2s; }
    .btn-primary { background:var(--primary-color); color:white; }
    .btn-primary:hover:not(:disabled) { background:#2563eb; }
    .btn-primary:disabled { background:#9ca3af; cursor:not-allowed; }
    .btn-secondary { background:white; color:var(--primary-color); border:1px solid var(--border-color); }
    .btn-secondary:hover { background:#f9fafb; }

    .btn-group { display:flex; gap:12px; margin-top:24px; flex-wrap: wrap; }

    .score-circle { width:150px; height:150px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:24px auto; font-size:36px; font-weight:700; color:white; }
    .score-good { background:var(--success-color); }
    .score-medium { background:#f59e0b; }
    .score-poor { background:var(--danger-color); }

    .flags { display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-top:32px; }
    .flag { padding:12px; margin-bottom:8px; border-radius:6px; background:#f3f4f6; font-size:14px; }
    .flag.green { background:#d1fae5; }
    .flag.red { background:#fee2e2; }

    textarea { width:100%; padding:12px; border:1px solid var(--border-color); border-radius:6px; font-family:inherit; font-size:14px; resize:vertical; }
  </style>
</head>

<body>
  <header>
    <div class="logo" onclick="navigate('welcome')" style="cursor:pointer;">AOJA</div>
    <div class="header-controls" id="headerControls"></div>
  </header>

  <div id="app">
    <div class="page active" id="welcome">
      <div class="container">
        <h1>Trauma-Informed Job Scanner</h1>
        <p style="margin-bottom:24px;">For ADHD & CPTSD professionals. Find workplaces that work with your nervous system, not against it.</p>
        <button class="btn btn-primary" onclick="startAssessment()">Start Free Scan</button>
      </div>
    </div>

    <div class="page" id="survey">
      <div class="container">
        <div class="progress-bar"><div class="progress-fill" id="surveyProgress" style="width:0%"></div></div>
        <div id="questionContainer"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" style="display:none;">Previous</button>
          <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>Next</button>
        </div>
      </div>
    </div>

    <div class="page" id="profile">
      <div class="container">
        <h2>Your Personal Profile</h2>
        <div id="profileSummary" style="margin-top:16px;"></div>
        <div style="text-align:center; margin-top:24px;">
          <button class="btn btn-primary" id="createAccountFromProfile" onclick="openSignUp()">Create Account</button>
          <button class="btn btn-primary" id="scanFromProfileBtn" style="display:none; margin-left:12px;" onclick="navigate('job')">Scan Job</button>
          <button class="btn btn-secondary" style="margin-left:12px;" onclick="retakeSurvey()">Retake Survey</button>
        </div>
      </div>
    </div>

    <div class="page" id="job">
      <div class="container">
        <h2>Paste Job Description</h2>
        <textarea id="jobDescription" rows="12" placeholder="Paste the full job description here..."></textarea>
        <div class="btn-group">
          <button class="btn btn-primary" id="scanBtn" onclick="scanJob()">Scan Job</button>
          <button class="btn btn-primary" id="buyCreditsBtn" onclick="buyMoreCredits()" style="display:none;">Buy More Credits</button>
          <button class="btn btn-secondary" onclick="navigate('profile')">Back to Profile</button>
        </div>
      </div>
    </div>

    <div class="page" id="results">
      <div class="container">
        <h2>Job Analysis Results</h2>
        <div class="score-circle" id="overallScore">-</div>
        <p style="text-align:center; margin-bottom:32px;">Overall Match</p>

        <h3>Dimensional Analysis</h3>
        <div id="dimensionalScores"></div>

        <div class="flags">
          <div>
            <h3>Green Flags</h3>
            <div id="greenFlags"></div>
          </div>
          <div>
            <h3>Red Flags</h3>
            <div id="redFlags"></div>
          </div>
        </div>

        <div class="btn-group" style="margin-top:24px;">
          <button class="btn btn-primary" id="downloadBtn" onclick="downloadReport()">Download Report (Free)</button>
          <button class="btn btn-secondary" onclick="navigate('profile')">Back to Profile</button>
          <button class="btn btn-secondary" onclick="navigate('job')">Scan Another Job</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Persisted local keys
    const LS_PROFILE = "aoja_profile";
    const LS_SURVEY = "aoja_survey_state";
    const LS_LAST_JOB = "aoja_last_job_result";
    const LS_LAST_JOB_TEXT = "aoja_last_job_text";

    const appState = {
      userId: null,
      credits: 0,
      clerkReady: false,
      profile: null,
      survey: {},
      currentQuestion: 0,
      lastJobResult: null
    };

    const questions = [
      { dimension: "safety_baseline", title: "What's your relationship with authority figures?", options: [
        { text:"I trust them", value:1 }, { text:"Mostly comfortable", value:3 }, { text:"It varies", value:5 }, { text:"Often anxious", value:8 }, { text:"I freeze up", value:10 }
      ]},
      { dimension: "adhd_wiring", title: "How do you work best?", options: [
        { text:"Deep focus blocks", value:1 }, { text:"Flexible schedule", value:3 }, { text:"Some structure", value:5 }, { text:"Lots of meetings", value:8 }, { text:"Constant interruptions", value:10 }
      ]},
      { dimension: "capability", title: "How do you handle new challenges?", options: [
        { text:"I thrive", value:1 }, { text:"I'm curious", value:3 }, { text:"Proceed cautiously", value:5 }, { text:"I need support", value:8 }, { text:"I panic", value:10 }
      ]},
      { dimension: "co_regulation", title: "What's your ideal team dynamic?", options: [
        { text:"Collaborative", value:1 }, { text:"Supportive", value:3 }, { text:"Independent", value:5 }, { text:"Competitive", value:8 }, { text:"Isolated", value:10 }
      ]},
      { dimension: "financial", title: "How important is salary transparency?", options: [
        { text:"Critical", value:1 }, { text:"Important", value:3 }, { text:"Nice to have", value:5 }, { text:"Not a priority", value:8 }, { text:"I avoid the topic", value:10 }
      ]}
    ];

    function getActivePageId() {
      return document.querySelector(".page.active")?.id || "welcome";
    }

    function saveSurveyState() {
      localStorage.setItem(LS_SURVEY, JSON.stringify({
        survey: appState.survey,
        currentQuestion: appState.currentQuestion
      }));
    }

    function loadSurveyState() {
      const raw = localStorage.getItem(LS_SURVEY);
      if (!raw) return false;
      try {
        const st = JSON.parse(raw);
        appState.survey = st.survey || {};
        appState.currentQuestion = Number.isFinite(st.currentQuestion) ? st.currentQuestion : 0;
        return true;
      } catch { return false; }
    }

    function clearSurveyState() { localStorage.removeItem(LS_SURVEY); }

    function saveProfileLocal(profile) { localStorage.setItem(LS_PROFILE, JSON.stringify(profile)); }
    function loadProfileLocal() {
      const raw = localStorage.getItem(LS_PROFILE);
      if (!raw) return false;
      try { appState.profile = JSON.parse(raw); return true; } catch { return false; }
    }
    function clearProfileLocal() { localStorage.removeItem(LS_PROFILE); }

    function saveLastJobResult(result) { localStorage.setItem(LS_LAST_JOB, JSON.stringify(result)); }
    function loadLastJobResult() {
      const raw = localStorage.getItem(LS_LAST_JOB);
      if (!raw) return false;
      try { appState.lastJobResult = JSON.parse(raw); return true; } catch { return false; }
    }

    function saveLastJobText(text) { localStorage.setItem(LS_LAST_JOB_TEXT, text || ""); }
    function loadLastJobText() {
      const t = localStorage.getItem(LS_LAST_JOB_TEXT);
      const ta = document.getElementById("jobDescription");
      if (ta && t !== null) ta.value = t;
    }

    function navigate(page) {
      const el = document.getElementById(page);
      if (!el) return;

      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      el.classList.add("active");

      if (page === "survey") renderQuestion();
      if (page === "profile") renderProfile();
      if (page === "job") { updateScanButton(); loadLastJobText(); }
      if (page === "results") {
        const r = appState.lastJobResult || (loadLastJobResult() ? appState.lastJobResult : null);
        if (r) displayResults(r);
      }
    }

    function updateHeaderForGuest() {
      const hc = document.getElementById("headerControls");
      hc.innerHTML = `
        <button class="btn btn-secondary" style="padding:8px 16px; font-size:14px;" id="signInBtn">Sign In</button>
        <button class="btn btn-primary" style="padding:8px 16px; font-size:14px;" id="signUpBtn">Create Account</button>
      `;
      document.getElementById("signInBtn").onclick = openSignIn;
      document.getElementById("signUpBtn").onclick = openSignUp;
    }

    function updateHeaderForAuth() {
      const hc = document.getElementById("headerControls");
      hc.innerHTML = `
        <button class="btn btn-secondary" style="padding:8px 16px; font-size:14px;" onclick="navigate('profile')">Profile</button>
        <div class="credit-display" id="creditDisplay">Credits: <span id="creditValue">-</span></div>
        <button class="btn btn-primary" style="padding:8px 16px; font-size:14px;" onclick="buyMoreCredits()">Buy Credits</button>
        <button class="btn btn-secondary" style="padding:8px 16px; font-size:14px;" onclick="signOutUser()">Sign Out</button>
      `;
      updateCreditDisplay();
    }

    function updateCreditDisplay() {
      const v = document.getElementById("creditValue");
      const d = document.getElementById("creditDisplay");
      if (!v || !d) return;
      v.textContent = String(appState.credits);
      d.classList.toggle("warning", appState.credits <= 2);
    }

    function updateScanButton() {
      const scanBtn = document.getElementById("scanBtn");
      const buyBtn = document.getElementById("buyCreditsBtn");
      if (!scanBtn || !buyBtn) return;

      if (!appState.userId) {
        scanBtn.textContent = "Scan Job (Sign in required)";
        scanBtn.style.display = "block";
        buyBtn.style.display = "none";
        return;
      }

      if (appState.credits > 0) {
        scanBtn.textContent = "Scan Job (1 Credit)";
        scanBtn.style.display = "block";
        buyBtn.style.display = "none";
      } else {
        scanBtn.style.display = "none";
        buyBtn.style.display = "block";
      }
    }

    // ---------- Clerk ----------
    let clerkLoadPromise = null;
    async function ensureClerkReady(timeoutMs = 12000) {
      const start = Date.now();
      while ((!window.Clerk || !window.Clerk.load) && (Date.now() - start) < timeoutMs) {
        await new Promise(r => setTimeout(r, 100));
      }
      if (!window.Clerk || !window.Clerk.load) throw new Error("Clerk script did not load.");
      if (!clerkLoadPromise) clerkLoadPromise = window.Clerk.load().then(() => { appState.clerkReady = true; });
      await clerkLoadPromise;
    }

    async function openSignIn() {
      try { await ensureClerkReady(); window.Clerk.openSignIn(); }
      catch (e) { console.error(e); alert("Sign-in unavailable."); }
    }

    async function openSignUp() {
      try { await ensureClerkReady(); window.Clerk.openSignUp(); }
      catch (e) { console.error(e); alert("Sign-up unavailable."); }
    }

    async function signOutUser() {
      if (!window.Clerk) return;
      await window.Clerk.signOut();
      appState.userId = null;
      appState.credits = 0;
      updateHeaderForGuest();
      updateScanButton();
    }

    async function apiAuthHeaders() {
      if (!appState.userId) return {};
      const token = await window.Clerk.session.getToken();
      return { "Authorization": `Bearer ${token}` };
    }

    async function initializeAccount() {
      const headers = await apiAuthHeaders();
      const resp = await fetch("/api/user/initialize", { method: "POST", headers });
      if (!resp.ok) throw new Error(await resp.text());
      return resp.json();
    }

    async function fetchCredits() {
      if (!appState.userId) return;
      const headers = await apiAuthHeaders();
      const resp = await fetch("/api/user/credits", { headers });
      if (!resp.ok) throw new Error(await resp.text());
      const data = await resp.json();
      appState.credits = data.credits ?? 0;
      updateCreditDisplay();
      updateScanButton();
    }

    async function fetchServerProfile() {
      if (!appState.userId) return null;
      const headers = await apiAuthHeaders();
      const resp = await fetch("/api/user/profile", { headers });
      if (!resp.ok) throw new Error(await resp.text());
      const data = await resp.json();
      return data.profile || null;
    }

    async function fetchLatestServerScanIntoState() {
      if (!appState.userId) return;
      const headers = await apiAuthHeaders();
      const resp = await fetch("/api/user/modules", { headers });
      if (!resp.ok) return;
      const data = await resp.json();
      const modules = data.modules || [];
      const latestWithScan = modules.find(m => m.scan_results);
      if (latestWithScan?.scan_results) {
        appState.lastJobResult = latestWithScan.scan_results;
        saveLastJobResult(appState.lastJobResult);
      }
    }

    async function transferLocalProfileToAccount() {
      if (!appState.userId) return;
      const local = localStorage.getItem(LS_PROFILE);
      if (!local) return;

      const profile = JSON.parse(local);
      const headers = await apiAuthHeaders();

      const payload = {
        survey: profile.survey || {},
        job_description: profile.job_description || "",
        scan_results: {
          overall_score: profile.overall_score,
          risk_level: profile.risk_level,
          summary: profile.summary,
          dimensional_match: profile.dimensional_match || [],
          critical_gaps: profile.critical_gaps || [],
          negotiation_priorities: profile.negotiation_priorities || [],
          green_flags: profile.green_flags || [],
          red_flags: profile.red_flags || []
        },
        created_at: profile.created_at || new Date().toISOString()
      };

      const resp = await fetch("/api/user/transfer-pending-module", {
        method: "POST",
        headers: { "Content-Type":"application/json", ...headers },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) throw new Error(await resp.text());

      clearProfileLocal();
      clearSurveyState();
    }

    // Critical: do not interrupt user on job/results during token refresh.
    async function initClerk() {
      try {
        await ensureClerkReady();

        const applySignedInState = async () => {
          const user = window.Clerk.user;
          const session = window.Clerk.session;

          const currentPage = getActivePageId();
          const allowAutoRoute = (currentPage === "welcome" || currentPage === "survey" || currentPage === "profile");

          if (!user || !session) {
            appState.userId = null;
            updateHeaderForGuest();
            updateScanButton();
            return;
          }

          appState.userId = user.id;
          updateHeaderForAuth();

          await initializeAccount();
          await fetchCredits();

          if (localStorage.getItem(LS_PROFILE)) {
            await transferLocalProfileToAccount();
          }

          const serverProfile = await fetchServerProfile();
          if (serverProfile) {
            appState.profile = serverProfile;
            saveProfileLocal(serverProfile);
          } else {
            loadProfileLocal();
          }

          await fetchLatestServerScanIntoState();
          loadLastJobResult();

          if (allowAutoRoute) {
            if (appState.profile) navigate("profile");
            else if (loadSurveyState()) navigate("survey");
            else navigate("survey");
          } else {
            updateScanButton();
          }
        };

        await applySignedInState();

        window.Clerk.addListener(async () => {
          try { await applySignedInState(); } catch (e) { console.warn("applySignedInState failed:", e); }
        });

      } catch (e) {
        console.warn("Clerk init failed; guest mode:", e);
        updateHeaderForGuest();
      }
    }

    // ---------- Survey ----------
    function renderQuestion() {
      const q = questions[appState.currentQuestion];
      const currentValue = appState.survey[q.dimension];

      document.getElementById("questionContainer").innerHTML = `
        <div>
          <h2>Question ${appState.currentQuestion + 1} of ${questions.length}</h2>
          <h3 style="margin:16px 0;">${q.title}</h3>
          <div class="options">
            ${q.options.map(opt => `
              <div class="option ${currentValue === opt.value ? "selected":""}"
                onclick="selectOption('${q.dimension}', ${opt.value}, this)">
                ${opt.text}
              </div>
            `).join("")}
          </div>
        </div>
      `;

      document.getElementById("surveyProgress").style.width =
        `${((appState.currentQuestion + 1) / questions.length) * 100}%`;

      document.getElementById("prevBtn").style.display = appState.currentQuestion > 0 ? "block" : "none";

      const nextBtn = document.getElementById("nextBtn");
      nextBtn.textContent = appState.currentQuestion === questions.length - 1 ? "Complete Survey" : "Next";
      nextBtn.disabled = (currentValue === undefined);
    }

    function selectOption(dimension, value, el) {
      document.querySelectorAll(".option").forEach(o => o.classList.remove("selected"));
      el.classList.add("selected");
      appState.survey[dimension] = value;
      saveSurveyState();
      document.getElementById("nextBtn").disabled = false;
    }

    function nextQuestion() {
      if (appState.currentQuestion < questions.length - 1) {
        appState.currentQuestion++;
        saveSurveyState();
        renderQuestion();
      } else {
        completeSurvey();
      }
    }

    function previousQuestion() {
      if (appState.currentQuestion > 0) {
        appState.currentQuestion--;
        saveSurveyState();
        renderQuestion();
      }
    }

    async function completeSurvey() {
      const survey = appState.survey;
      const headers = await apiAuthHeaders();

      const resp = await fetch("/api/scan-job", {
        method: "POST",
        headers: { "Content-Type":"application/json", ...headers },
        body: JSON.stringify({ job_description: "", trauma: survey, consume_credit: false })
      });

      const result = resp.ok ? await resp.json() : null;

      const profile = { survey, ...(result || {}), created_at: new Date().toISOString() };
      appState.profile = profile;
      saveProfileLocal(profile);
      clearSurveyState();

      if (appState.userId) {
        try {
          await transferLocalProfileToAccount();
          const serverProfile = await fetchServerProfile();
          if (serverProfile) {
            appState.profile = serverProfile;
            saveProfileLocal(serverProfile);
          }
        } catch (e) {
          console.warn("Persist profile failed:", e);
        }
      }

      navigate("profile");
    }

    function retakeSurvey() {
      appState.profile = null;
      appState.survey = {};
      appState.currentQuestion = 0;
      clearProfileLocal();
      clearSurveyState();
      navigate("survey");
    }

    function renderProfile() {
      const el = document.getElementById("profileSummary");
      const profile = appState.profile || (loadProfileLocal() ? appState.profile : null);

      if (!profile) {
        el.innerHTML = `<p style="color:#6b7280;">No profile yet. Complete the survey.</p>`;
        return;
      }

      const overall = (typeof profile.overall_score === "number") ? profile.overall_score : null;
      const scoreClass = overall === null ? "score-medium" : (overall >= 70 ? "score-good" : overall >= 40 ? "score-medium" : "score-poor");
      const scoreText = overall === null ? "-" : `${Math.round(overall)}%`;

      const dims = Array.isArray(profile.dimensional_match) ? profile.dimensional_match : [];
      const firstDim = dims[0];

      const lastScan = appState.lastJobResult || (loadLastJobResult() ? appState.lastJobResult : null);
      const lastScanScore = typeof lastScan?.overall_score === "number" ? `${Math.round(lastScan.overall_score)}%` : null;

      el.innerHTML = `
        <div style="text-align:center;">
          <div class="score-circle ${scoreClass}" style="width:120px;height:120px;margin:0 auto;">${scoreText}</div>
          <p style="margin-top:12px;">${profile.risk_level ? String(profile.risk_level).toUpperCase() : ""}</p>
        </div>

        <div style="margin-top:16px;">
          ${firstDim ? `
            <div style="padding:12px; border:1px solid var(--border-color); border-radius:8px;">
              <div style="display:flex; justify-content:space-between;">
                <strong>${firstDim.dimension}</strong>
                <span style="font-weight:600;">${firstDim.match_percentage}%</span>
              </div>
              <div style="margin-top:8px; font-size:13px; color:#6b7280;">${firstDim.risk_level}</div>
            </div>
          ` : `<p style="color:#6b7280;">Dimensional profile not available yet.</p>`}
        </div>

        <div style="margin-top:16px; padding:12px; border:1px solid var(--border-color); border-radius:8px;">
          <strong>Most Recent Job Scan:</strong>
          <div style="margin-top:8px; color:#6b7280;">
            ${lastScanScore ? `${lastScanScore} overall match` : `No job scanned yet.`}
          </div>
          ${lastScanScore ? `<button class="btn btn-secondary" style="margin-top:12px;" onclick="navigate('results')">View Last Results</button>` : ``}
        </div>
      `;

      const createBtn = document.getElementById("createAccountFromProfile");
      const scanBtn = document.getElementById("scanFromProfileBtn");

      if (!appState.userId) {
        createBtn.style.display = "inline-block";
        scanBtn.style.display = "none";
      } else {
        createBtn.style.display = "none";
        scanBtn.style.display = "inline-block";
      }
    }

    // ---------- Job scan ----------
    async function scanJob() {
      const jobText = document.getElementById("jobDescription").value.trim();
      saveLastJobText(jobText);

      if (!jobText) return alert("Please paste a job description.");
      if (!appState.userId) return openSignUp();
      if (!appState.profile?.survey) {
        alert("Please complete the survey first.");
        return navigate("survey");
      }
      if (appState.credits <= 0) return alert("No credits remaining.");

      const scanBtn = document.getElementById("scanBtn");
      scanBtn.disabled = true;
      scanBtn.textContent = "Scanning...";

      try {
        const headers = await apiAuthHeaders();
        const resp = await fetch("/api/scan-job", {
          method: "POST",
          headers: { "Content-Type":"application/json", ...headers },
          body: JSON.stringify({
            job_description: jobText,
            trauma: appState.profile.survey,
            consume_credit: true
          })
        });

        if (!resp.ok) throw new Error(await resp.text());

        const result = await resp.json();
        appState.lastJobResult = result;
        saveLastJobResult(result);

        displayResults(result);
        navigate("results");

        await fetchCredits();
      } catch (e) {
        console.error("scanJob failed:", e);
        alert("Job scanning failed: " + (e?.message || "unknown error"));
      } finally {
        scanBtn.disabled = false;
        updateScanButton();
      }
    }

    function displayResults(result) {
      const scoreEl = document.getElementById("overallScore");
      const overall = typeof result?.overall_score === "number" ? result.overall_score : 0;
      scoreEl.textContent = `${Math.round(overall)}%`;
      scoreEl.className = `score-circle ${overall >= 70 ? "score-good" : overall >= 40 ? "score-medium" : "score-poor"}`;

      const dims = Array.isArray(result?.dimensional_match) ? result.dimensional_match : [];
      document.getElementById("dimensionalScores").innerHTML = dims.map(dim => {
        const pct = typeof dim.match_percentage === "number" ? dim.match_percentage : 0;
        return `
          <div style="margin-bottom:16px; padding:12px; border:1px solid var(--border-color); border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
              <strong>${dim.dimension}</strong>
              <span style="font-weight:600;">${pct}%</span>
            </div>
            <div style="width:100%; background:var(--border-color); height:8px; border-radius:4px; overflow:hidden;">
              <div style="width:${pct}%; height:8px; background:${dim.critical ? "#ef4444" : pct < 75 ? "#f59e0b" : "#10b981"};"></div>
            </div>
            <div style="font-size:14px; color:#6b7280; margin-top:4px;">${dim.risk_level}</div>
          </div>
        `;
      }).join("");

      const greens = Array.isArray(result?.green_flags) ? result.green_flags : [];
      const reds = Array.isArray(result?.red_flags) ? result.red_flags : [];

      document.getElementById("greenFlags").innerHTML = greens.length
        ? greens.map(f => `<div class="flag green">${f}</div>`).join("")
        : `<div class="flag">No strong green flags detected</div>`;

      document.getElementById("redFlags").innerHTML = reds.length
        ? reds.map(f => `<div class="flag red">${f}</div>`).join("")
        : `<div class="flag">No major red flags detected</div>`;
    }

    // Download must NOT clear results
    function downloadReport() {
      if (!appState.userId) return openSignUp();

      const result = appState.lastJobResult || (loadLastJobResult() ? appState.lastJobResult : null);
      if (!result) return alert("No report available. Please scan a job first.");

      const report = {
        downloaded_at: new Date().toISOString(),
        user_id: appState.userId,
        survey_responses: appState.profile?.survey || appState.survey || {},
        ...result
      };

      const blob = new Blob([JSON.stringify(report, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `job-analysis-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      // Explicitly keep results rendered
      if (getActivePageId() === "results" && appState.lastJobResult) {
        displayResults(appState.lastJobResult);
      }
    }

    // ---------- Stripe Buy Credits ----------
    function loadStripeJs() {
      return new Promise((resolve, reject) => {
        if (window.Stripe) return resolve(window.Stripe);
        const s = document.createElement("script");
        s.src = "https://js.stripe.com/v3/";
        s.onload = () => resolve(window.Stripe);
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    async function buyMoreCredits() {
      if (!appState.userId) {
        alert("Please sign in to buy credits.");
        return openSignIn();
      }

      const pk = window.STRIPE_PUBLISHABLE_KEY;
      if (!pk) {
        alert("Stripe publishable key missing. Check backend injection.");
        return;
      }

      try {
        await loadStripeJs();
        const headers = await apiAuthHeaders();

        const resp = await fetch("/api/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...headers },
          body: JSON.stringify({ credits_to_purchase: 1 })
        });

        if (!resp.ok) throw new Error(await resp.text());

        const data = await resp.json();
        const stripe = window.Stripe(pk);
        const { error } = await stripe.redirectToCheckout({ sessionId: data.sessionId });

        if (error) throw new Error(error.message);
      } catch (e) {
        console.error("buyMoreCredits error:", e);
        alert("Failed to start Stripe checkout: " + (e?.message || "unknown error"));
      }
    }

    // ---------- Start / Restore ----------
    function startAssessment() {
      loadSurveyState();
      loadProfileLocal();
      loadLastJobResult();
      navigate("survey");
    }

    window.addEventListener("DOMContentLoaded", () => {
      // show guest header immediately
      updateHeaderForGuest();

      // restore local state
      loadSurveyState();
      loadProfileLocal();
      loadLastJobResult();

      // handle payment return
      const p = new URLSearchParams(window.location.search);
      if (p.get("payment") === "success") {
        // clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
        // credits will refresh after Clerk initializes (if signed in),
        // but also try immediately if already signed in:
        setTimeout(() => { if (appState.userId) fetchCredits(); }, 1000);
        alert("Credits purchased successfully.");
      }
    });

    window.addEventListener("load", () => {
      initClerk();
    });
  </script>
</body>
</html>